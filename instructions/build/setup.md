# Environment Setup Guide

Complete guide for configuring databases, credentials, and secrets across environments.

→ Full configuration reference: [core/instructions/information/config.md](../../core/instructions/information/config.md)

---

## Quick Start

```bash
just login   # Authenticate with SystemPrompt Cloud
just setup   # Link project to a tenant
just config  # Configure environment (creates profile, secrets, database)
```

---

## Configuration Components

Each environment requires three components:

| Component | Format | Contains | Location |
|-----------|--------|----------|----------|
| **Profile** | YAML | All config (db, server, paths, security) | `.systemprompt/profiles/{env}.secrets.profile.yml` |
| **Secrets** | JSON | API keys (Gemini, Anthropic, OpenAI) | `.systemprompt/secrets.json` |
| **Credentials** | JSON | Cloud auth (API token, tenant ID) | `.systemprompt/credentials.json` |

### Profile

The master configuration file. Contains everything needed to run the application.

```yaml
name: local
database:
  url: postgres://user:pass@localhost:5432/mydb
server:
  port: 8080
  api_external_url: http://localhost:8080
security:
  jwt_secret: <32+ characters>
secrets:
  secrets_path: ../secrets.json
cloud:
  credentials_path: ../credentials.json
  enabled: false
  validation: skip
```

### Secrets

API keys for AI providers. Separate from profile for security.

```json
{
  "gemini": "AIzaSy...",
  "anthropic": "sk-ant-...",
  "openai": "sk-..."
}
```

### Credentials

Cloud authentication tokens. Generated by `systemprompt cloud login`.

```json
{
  "api_token": "eyJhbG...",
  "api_url": "https://api.systemprompt.io",
  "tenant_id": "tenant_123",
  "app_id": "app_456",
  "hostname": "myapp.systemprompt.io"
}
```

---

## Setup Flow

### Step 1: Cloud Login

Authenticate with SystemPrompt Cloud using OAuth.

```bash
systemprompt cloud login
```

**What it does:**
- Opens browser for GitHub/Google OAuth
- Saves credentials to `.systemprompt/credentials/{env}.credentials.json`
- Displays user info and available subscriptions

### Step 2: Cloud Setup

Link this project to a cloud tenant.

```bash
systemprompt cloud setup --name my-project --region iad
```

**What it does:**
- Lists existing tenants or creates new one
- Configures tenant in credentials file
- Polls for tenant provisioning (1-2 minutes)

**Arguments:**
| Flag | Description |
|------|-------------|
| `--name <name>` | Tenant name |
| `--region <region>` | Cloud region (default: iad) |

### Step 3: Cloud Config

Interactive wizard for complete environment setup.

```bash
systemprompt cloud config
```

**What it does:**
1. Prompts for environment (Local, Production, Both)
2. For local: Sets up Docker PostgreSQL
3. Generates profile YAML with all settings
4. Creates secrets.json with API keys
5. Runs database migrations

**Generated files:**
```
.systemprompt/
├── profiles/
│   └── local.secrets.profile.yml
├── secrets.json
├── credentials.json
└── docker-compose.yml
```

### Step 4: Database Setup

Start the database and run migrations.

```bash
# Start PostgreSQL (if using Docker)
just db-up

# Run migrations
just db-migrate
```

### Step 5: Verify

Check configuration status.

```bash
systemprompt cloud status
```

---

## Per-Environment Setup

### Development (local)

```bash
export SYSTEMPROMPT_PROFILE=.systemprompt/profiles/local.secrets.profile.yml
just up      # Start PostgreSQL
just start   # Run server
```

### Production

```bash
export SYSTEMPROMPT_PROFILE=.systemprompt/profiles/production.secrets.profile.yml
just deploy  # Build and deploy
```

**Fly.io secrets (set via `fly secrets set`):**
```bash
fly secrets set \
  GEMINI_API_KEY="..." \
  ANTHROPIC_API_KEY="..." \
  SYSTEMPROMPT_API_TOKEN="..." \
  SYSTEMPROMPT_TENANT_ID="..."
```

---

## Just Commands

| Command | Purpose |
|---------|---------|
| `just login` | Authenticate with OAuth |
| `just logout` | Clear credentials |
| `just status` | Check auth and tenant status |
| `just setup` | Link project to tenant |
| `just config` | Interactive config wizard |
| `just show` | Display configuration |
| `just up` | Start PostgreSQL |
| `just down` | Stop PostgreSQL |
| `just migrate` | Run database migrations |
| `just reset` | Reset database |
| `just start` | Start server |
| `just deploy` | Build and deploy |
| `just push` | Push files to cloud |
| `just pull` | Pull files from cloud |
| `just sync` | Full sync + deploy |
| `just dev` | up + migrate + start |
| `just fresh` | reset + migrate + start |
| `just cli <args>` | CLI passthrough |

---

## Common Workflows

### New Project Setup

```bash
git clone https://github.com/systemprompt/template my-project
cd my-project
git submodule update --init --recursive
just login
just setup --name my-project
just config
just dev
```

### Adding a New Environment

```bash
cp .systemprompt/profiles/local.secrets.profile.yml .systemprompt/profiles/staging.secrets.profile.yml
$EDITOR .systemprompt/profiles/staging.secrets.profile.yml
just login
just setup --name staging
```

### Refreshing Expired Token

```bash
just status  # Check token
just login   # Re-authenticate
```

### Deploy to Production

```bash
export SYSTEMPROMPT_PROFILE=.systemprompt/profiles/production.secrets.profile.yml
just deploy
fly ssh console -C "systemprompt db migrate"
```

---

## Troubleshooting

### Profile Not Found

```
Profile initialization failed. Set SYSTEMPROMPT_PROFILE environment variable
```

**Fix:**
```bash
export SYSTEMPROMPT_PROFILE=/absolute/path/to/profile.yml
```

### Secrets File Not Found

```
Secrets file not found: ./secrets.json
```

**Fix:** Create secrets file or set validation to skip:
```yaml
secrets:
  secrets_path: ./secrets.json
  validation: skip
```

### Cloud Token Expired

```
Cloud token has expired. Run 'systemprompt cloud login' to refresh
```

**Fix:** `just login`

### Database Connection Failed

```
Failed to connect to database
```

**Fix:** `just up` then verify with `docker ps | grep postgres`

### JWT Secret Too Short

```
Security jwt_secret must be at least 32 characters
```

**Fix:** Generate a longer secret:
```bash
openssl rand -base64 48
```

---

## File Structure

```
.systemprompt/
├── profiles/
│   ├── local.secrets.profile.yml
│   └── production.secrets.profile.yml
├── secrets.json
├── credentials.json
└── docker-compose.yml
```

**All files in `.systemprompt/` are gitignored.**

---

## Security Notes

1. **Never commit secrets** - All `.systemprompt/` files are gitignored
2. **File permissions** - Secrets files created with `0o600`
3. **JWT secret length** - Minimum 32 characters enforced
4. **Fly.io secrets** - Use `fly secrets set` for production
5. **Token expiration** - Cloud credentials validated on load
